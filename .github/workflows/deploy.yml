name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Azure VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/heat-prediction
            echo "Starting deployment from branch: ${{ github.event.inputs.branch }}"
            
            # Update code
            git fetch origin
            git checkout ${{ github.event.inputs.branch }}
            git pull origin ${{ github.event.inputs.branch }}
            
            # Setup Backend
            cd apps/backend
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install -r requirements.txt
            deactivate
            cd ../..
            
            # Setup Frontend
            cd apps/frontend-simple
            npm install
            npm run build
            cd ../..
            
            # Restart Services
            pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
            pm2 save
            
            echo "Deployment successful!"
